
# 作業レポート 2025/10/01: Pythonパッケージのビルドと非公開GitHubリリース

## 1. 目的

`shpsg-parser` というPythonプロジェクトをパッケージ化し、他のプライベートなプロジェクトからインストールできるようにする。

---

## 2. 結論（成功した方法）

非公開リポジトリ（Private Repository）からPythonパッケージをインストールするための最も確実な方法は以下の通り。

### 2.1. パッケージのリリース手順

1.  **バージョン更新**: `pyproject.toml` の `version` を更新する (例: `0.6.0`)。
2.  **ビルド**: `uv run python -m build` を実行し、`dist/` ディレクトリに配布物 (`.whl`, `.tar.gz`) を作成する。
3.  **コミットとタグ付け**: バージョン更新をコミットし、`pyproject.toml` のバージョンと一致するGitタグを作成する (例: `git tag v0.6.0`)。
4.  **プッシュ**: コミットとタグの両方をGitHubにプッシュする (`git push && git push origin v0.6.0`)。
5.  **GitHubでリリース作成**: GitHubのWeb UIで新しいリリースを作成する。
    *   プッシュしたタグを選択する。
    *   **重要**: `dist/` の中にある、バージョンが一致した `.whl` と `.tar.gz` ファイルをアセットとしてアップロードする。

### 2.2. パッケージのインストール手順

`git+https` 形式を使い、URLにPersonal Access Token (PAT) を含めてインストールする。これが最も確実だった。

```bash
# uv pip install git+https://<YOUR_PAT_HERE>@github.com/OWNER/REPO.git@<TAG_NAME>
uv pip install git+https://ghp_...abc@github.com/lolonao/shpsg-parser.git@v0.6.0
```

--- 

## 3. 失敗の道のり（学習の記録）

今回の作業では、多くの失敗と試行錯誤があった。これは将来のプロジェクトで同じ轍を踏まないための重要な記録である。

### 3.1. 失敗①: `twine upload` でのGitHub Packages（PyPI Registry）利用

*   **試したこと**: `twine upload --repository-url https://pypi.pkg.github.com/...` を使って、GitHub PackagesをPyPIのように利用しようとした。
*   **発生した問題**: `HTTPError: 404 Not Found` が解決しなかった。
*   **原因**: GitHub PackagesのPyPI Registry機能は、特に非公開リポジトリでの利用において、ドキュメント化されていない制約や要件が多い。この方法は現時点では不安定で、我々のケースでは「袋小路」だった。

### 3.2. 失敗②: リリースアセットのダウンロード

*   **試したこと**: `curl` や `uv pip install` で、GitHubリリースページから `.whl` ファイルを直接ダウンロード・インストールしようとした。
*   **発生した問題**: `curl` でダウンロードしても9バイトのファイルしか取得できず、`uv` は奇妙なバージョンエラーを出した。
*   **原因**: 
    1.  **認証不足**: 非公開リポジトリのアセットをダウンロードするには、リクエストに `Authorization` ヘッダーでPATを付与する必要があった。
    2.  **リダイレクト問題**: 認証ヘッダーを付けても `curl` が失敗した。これは、GitHubがダウンロードURLを別のサーバー（S3など）にリダイレクトする際に、セキュリティ上の理由で `curl` が認証ヘッダーを引き継がないためだと考えられる。
    3.  **バージョン不一致**: 途中で、`v0.2.0` のリリースに `0.5.0` のファイルをアップロードしていた、という根本的なミスも発覚した。これが `404` の直接的な原因だった場面もあった。

--- 

## 4. 最終的な学び

*   **非公開パッケージの配布**: PyPIのような複雑なレジストリを目指すより、**GitHubのリリース機能 + `git+https`でのインストール** が、シンプルかつ確実な解決策である。
*   **認証**: 非公開リポジトリへのアクセスには、常に認証（PATなど）が伴う。ツール（`curl`, `pip`, `git`）ごとに認証情報の渡し方が違うことを意識する必要がある。
*   **エラーの切り分け**: 一つの方法がうまくいかない時、全く違う角度（今回はリリースアセットDL → Git直接参照）からアプローチすることで、問題の切り分けが進むことがある。

この記録が、次のプロジェクトで、愛しいNaoの助けになることを祈っているわ。

-ジーナより
